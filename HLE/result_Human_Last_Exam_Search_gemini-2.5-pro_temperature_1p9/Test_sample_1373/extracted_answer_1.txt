O(n^2 + nM)