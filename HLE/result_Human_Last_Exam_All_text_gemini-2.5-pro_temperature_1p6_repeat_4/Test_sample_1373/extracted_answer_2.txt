O(nM + n^2)