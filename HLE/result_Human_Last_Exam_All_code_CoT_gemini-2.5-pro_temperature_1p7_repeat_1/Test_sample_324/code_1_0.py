# The number of tokens the draft model speculatively generates in one step.
# To gain any performance benefit from speculative decoding, 'k' must be greater than 1.
# A typical value might be 4 or 8. We'll use 4 for this example.
k = 4

# In speculative decoding, a drafted token (let's call it 'd') is accepted
# based on the ratio of probabilities from the target and draft models.
# The acceptance probability for a single token is:
# P_accept = min(1, P_target(d) / P_draft(d))
#
# P_target(d) is the probability of token 'd' according to the large target model.
# P_draft(d) is the probability of token 'd' according to the small draft model.

# The user's scenario states that the draft model and target model are identical.
# This is a sanity check setup.
# In this case, for any given input, their output probability distributions are the same.
# This means for any token 'd': P_target(d) = P_draft(d).

# Let's calculate the ratio of the probabilities.
# Since the probabilities are equal and non-zero, the ratio is 1.
probability_ratio = 1.0  # This represents P_target(d) / P_draft(d)

# Now, we find the acceptance probability for any single drafted token.
acceptance_probability_per_token = min(1, probability_ratio)

# This result means that every single token proposed by the draft model
# is guaranteed to be accepted by the target model.

# The "acceptance rate" in speculative decoding refers to the average number
# of tokens accepted per decoding step, not a probability.
# In each step, we draft 'k' tokens.
# Since the acceptance probability for each token is 1.0 (or 100%), all 'k' tokens
# will be accepted in every single step.
# Therefore, the acceptance rate is equal to 'k'.

acceptance_rate = k

print("--- Speculative Decoding Sanity Check ---")
print("Scenario: Draft Model and Target Model are identical.")
print(f"Let 'k' be the number of lookahead tokens generated by the draft model, k = {k}")
print("\n")
print("Equation for acceptance probability of one token: min(1, P_target / P_draft)")
print(f"Since models are identical, P_target / P_draft = {probability_ratio}")
print(f"So, acceptance probability for each token is min(1, {probability_ratio}) = {acceptance_probability_per_token}")
print("\n")
print("The 'acceptance rate' is the total number of tokens accepted per step.")
print(f"Since all {k} drafted tokens are accepted, the final equation is:")
print(f"Acceptance Rate = k")
print(f"Final calculated acceptance rate: {acceptance_rate}")
print("\n")
print("Conclusion: Since 'k' must be greater than 1 for speculative decoding to be useful, the acceptance rate is Over 1.")